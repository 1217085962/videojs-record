/*! videojs-record v0.9.0
* https://github.com/collab-project/videojs-record
* Copyright (c) 2014-2015 - Licensed MIT */
!function(a,b){"use strict";b.RecordBase=b.Component.extend({IMAGE_ONLY:"image_only",AUDIO_ONLY:"audio_only",VIDEO_ONLY:"video_only",AUDIO_VIDEO:"audio_video",ANIMATION:"animation",RECORDRTC:"recordrtc",LIBVORBISJS:"libvorbis.js",isEdge:function(){return!(-1===navigator.userAgent.indexOf("Edge")||!navigator.msSaveBlob&&!navigator.msSaveOrOpenBlob)},isOpera:function(){return!!a.opera||-1!==navigator.userAgent.indexOf("OPR/")},isChrome:function(){return!this.isOpera()&&!this.isEdge()&&!!navigator.webkitGetUserMedia},init:function(a,c,d){b.Component.call(this,a,c,d)}}),b.RecordRTCEngine=b.RecordBase.extend({setup:function(a,b,c){this.inputStream=a,this.mediaType=b,this.debug=c,this.engine=new MRecordRTC,this.engine.mediaType=this.mediaType,this.engine.disableLogs=!this.debug,this.engine.bufferSize=this.bufferSize,this.engine.sampleRate=this.sampleRate,this.engine.quality=this.quality,this.engine.frameRate=this.frameRate,this.engine.addStream(this.inputStream)},start:function(){this.engine.startRecording()},stop:function(){this.engine.stopRecording(this.onStopRecording.bind(this))},onStopRecording:function(a,b){this.mediaURL=a;var c=this.player().recorder.getRecordType();this.engine.getBlob(function(a){switch(c){case this.AUDIO_ONLY:this.recordedData=a.audio,this.trigger("recordComplete");break;case this.VIDEO_ONLY:case this.AUDIO_VIDEO:void 0!==a.video&&(this.recordedData=a.video,c===this.AUDIO_VIDEO&&this.isChrome()&&(this.recordedData=a),this.trigger("recordComplete"));break;case this.ANIMATION:this.recordedData=a.gif,this.trigger("recordComplete")}}.bind(this))}}),b.LibVorbisEngine=b.RecordBase.extend({setup:function(a,b,c){this.inputStream=a,this.mediaType=b,this.debug=c,this.options={workerURL:this.audioWorkerURL,moduleURL:this.audioModuleURL,encoderOptions:{channels:2,sampleRate:this.sampleRate,quality:.8}}},start:function(){this.chunks=[],this.audioContext=new AudioContext,this.audioSourceNode=this.audioContext.createMediaStreamSource(this.inputStream),this.scriptProcessorNode=this.audioContext.createScriptProcessor(this.bufferSize),libvorbis.OggVbrAsyncEncoder.create(this.options,this.onData.bind(this),this.onStopRecording.bind(this)).then(this.onEngineCreated.bind(this))},stop:function(){this.audioSourceNode.disconnect(this.scriptProcessorNode),this.scriptProcessorNode.disconnect(this.audioContext.destination),this.encoder.finish()},onEngineCreated:function(a){this.encoder=a,this.scriptProcessorNode.onaudioprocess=this.onAudioProcess.bind(this),this.audioSourceNode.connect(this.scriptProcessorNode),this.scriptProcessorNode.connect(this.audioContext.destination)},onAudioProcess:function(a){var b=a.inputBuffer,c=(b.length,b.getChannelData(0)),d=b.getChannelData(1);c=new Float32Array(c),d=new Float32Array(d);var e=[c,d];this.encoder.encode(e)},onData:function(a){this.chunks.push(a)},onStopRecording:function(){this.recordedData=new Blob(this.chunks,{type:"audio/ogg"}),this.mediaURL=URL.createObjectURL(this.recordedData),this.trigger("recordComplete")}}),b.Recorder=b.RecordBase.extend({init:function(a,c,d){switch(b.Component.call(this,a,c,d),this.recordImage=this.options().options.image,this.recordAudio=this.options().options.audio,this.recordVideo=this.options().options.video,this.recordAnimation=this.options().options.animation,this.maxLength=this.options().options.maxLength,this.debug=this.options().options.debug,this.audioEngine=this.options().options.audioEngine,this.audioWorkerURL=this.options().options.audioWorkerURL,this.audioModuleURL=this.options().options.audioModuleURL,this.audioBufferSize=this.options().options.audioBufferSize,this.audioSampleRate=this.options().options.audioSampleRate,this.animationFrameRate=this.options().options.animationFrameRate,this.animationQuality=this.options().options.animationQuality,this._recording=!1,this._processing=!1,this.getUserMedia=(navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia).bind(navigator),this.getRecordType()){case this.AUDIO_ONLY:this.surfer=a.waveform,this.playhead=this.surfer.el().getElementsByTagName("wave")[1],this.playhead.style.display="none";break;case this.IMAGE_ONLY:case this.VIDEO_ONLY:case this.AUDIO_VIDEO:case this.ANIMATION:this.player().bigPlayButton.hide(),this.player().options().controls&&(this.player().controlBar.progressControl.hide(),this.player().on("userinactive",function(a){this.player().userActive(!0)}),this.player().controlBar.show(),this.player().controlBar.el().style.display="block",this.player().off("timeupdate"))}this.setDuration(this.maxLength),this.player().controlBar.playToggle.hide()},isRecording:function(){return this._recording},isProcessing:function(){return this._processing},getDevice:function(){switch(this.getRecordType()){case this.AUDIO_ONLY:this.mediaType={audio:!0,video:!1},this.surfer.microphone.on("deviceReady",this.onDeviceReady.bind(this)),this.surfer.microphone.on("deviceError",this.onDeviceError.bind(this)),this.player().play();break;case this.IMAGE_ONLY:case this.VIDEO_ONLY:this.mediaType={audio:!1,video:!0},this.getUserMedia(this.mediaType,this.onDeviceReady.bind(this),this.onDeviceError.bind(this));break;case this.AUDIO_VIDEO:this.mediaType={audio:!0,video:!0},this.getUserMedia(this.mediaType,this.onDeviceReady.bind(this),this.onDeviceError.bind(this));break;case this.ANIMATION:this.mediaType={audio:!1,video:!1,gif:!0},this.getUserMedia({audio:!1,video:!0},this.onDeviceReady.bind(this),this.onDeviceError.bind(this))}},onDeviceReady:function(a){if(this.stream=a,this.player().trigger("deviceReady"),this.player().deviceButton.hide(),this.player().controlBar.liveDisplay.hide(),this.getRecordType()!==this.IMAGE_ONLY){if(this.getRecordType()!==this.AUDIO_ONLY&&this.audioEngine===this.LIBVORBISJS)throw new Error("Currently libvorbis.js is only supported in audio-only mode.");this.audioEngine===this.RECORDRTC?this.engine=new b.RecordRTCEngine(this.player()):this.audioEngine===this.LIBVORBISJS&&(this.engine=new b.LibVorbisEngine(this.player())),this.engine.on("recordComplete",this.onRecordComplete.bind(this)),this.engine.bufferSize=this.audioBufferSize,this.engine.sampleRate=this.audioSampleRate,this.engine.audioWorkerURL=this.audioWorkerURL,this.engine.audioModuleURL=this.audioModuleURL,this.engine.quality=this.animationQuality,this.engine.frameRate=this.animationFrameRate,this.engine.setup(this.stream,this.mediaType,!this.debug);var c,d=[this.player().controlBar.currentTimeDisplay,this.player().controlBar.timeDivider,this.player().controlBar.durationDisplay];for(c in d)d[c].el().style.display="block",d[c].show();this.player().recordToggle.show()}else this.player().recordIndicator.disable(),this.player().cameraButton.show();this.getRecordType()!==this.AUDIO_ONLY&&(this.mediaElement=this.player().el().firstChild,this.mediaElement.muted=!0,this.mediaElement.controls=!1,this.load(URL.createObjectURL(this.stream)),this.mediaElement.play())},onDeviceError:function(a){this.player().deviceErrorCode=a,this.player().trigger("deviceError")},start:function(){if(!this.isProcessing()){switch(this._recording=!0,this.player().controlBar.playToggle.hide(),this.getRecordType()){case this.AUDIO_ONLY:this.surfer.setupPlaybackEvents(!1),this.playhead.style.display="none",this.surfer.liveMode=!0,this.player().play();break;case this.VIDEO_ONLY:case this.AUDIO_VIDEO:this.startVideoPreview();break;case this.ANIMATION:this.player().recordCanvas.hide(),this.player().animationDisplay.hide(),this.mediaElement.style.display="block",this.captureFrame(),this.startVideoPreview()}this.getRecordType()!==this.IMAGE_ONLY?(this.startTime=(new Date).getTime(),this.countDown=this.setInterval(this.onCountDown.bind(this),100),this.engine.start()):this.createSnapshot(),this.trigger("startRecord")}},stop:function(){this.isProcessing()||(this._recording=!1,this._processing=!0,this.trigger("stopRecord"),this.getRecordType()!==this.IMAGE_ONLY?(this.clearInterval(this.countDown),this.engine.stop()):this.trigger("finishRecord"))},stopDevice:function(){if(this.isRecording()&&this.stop(),this.stream)if(this.isChrome()){var a;switch(this.getRecordType()){case this.AUDIO_ONLY:a=this.stream.getAudioTracks()[0],a.stop();break;case this.VIDEO_ONLY:case this.ANIMATION:case this.IMAGE_ONLY:a=this.stream.getVideoTracks()[0],a.stop();break;case this.AUDIO_VIDEO:a=this.stream.getTracks();for(var b in a)a[b].stop()}}else this.stream.stop()},onRecordComplete:function(){switch(this.mediaURL=this.engine.mediaURL,this.getRecordType()){case this.AUDIO_ONLY:this.player().controlBar.playToggle.show(),this.player().recordedData=this.engine.recordedData,this.trigger("finishRecord"),this.player().one("pause",function(){this.surfer.setupPlaybackEvents(!0),this.player().loadingSpinner.show(),this.playhead.style.display="block",this.surfer.surfer.once("ready",function(){this._processing=!1}.bind(this)),this.load(this.player().recordedData)}.bind(this)),this.player().pause();break;case this.VIDEO_ONLY:case this.AUDIO_VIDEO:this.player().controlBar.playToggle.show(),this.player().recordedData=this.engine.recordedData,this.trigger("finishRecord"),this.off(this.player(),"pause",this.onPlayerPause),this.off(this.player(),"play",this.onPlayerStart),this.player().one("pause",function(){this._processing=!1,this.player().loadingSpinner.hide(),this.setDuration(this.streamDuration),this.on(this.player(),"timeupdate",function(){this.setCurrentTime(this.player().currentTime(),this.streamDuration)}.bind(this)),this.getRecordType()===this.AUDIO_VIDEO&&this.isChrome()&&(void 0===this.extraAudio&&(this.extraAudio=this.player().createEl("audio"),this.extraAudio.id="extraAudio"),this.extraAudio.src=URL.createObjectURL(this.player().recordedData.audio),this.on(this.player(),"pause",this.onPlayerPause)),this.on(this.player(),"play",this.onPlayerStart),this.getRecordType()===this.AUDIO_VIDEO&&(this.mediaElement.muted=!1),this.load(this.mediaURL)}.bind(this)),this.player().pause();break;case this.ANIMATION:this.player().controlBar.playToggle.show(),this.player().recordedData=this.engine.recordedData,this.trigger("finishRecord"),this._processing=!1,this.player().loadingSpinner.hide(),this.setDuration(this.streamDuration),this.mediaElement.style.display="none",this.player().recordCanvas.show(),this.player().pause(),this.on(this.player(),"play",this.showAnimation),this.on(this.player(),"pause",this.hideAnimation)}},onCountDown:function(){var a=((new Date).getTime()-this.startTime)/1e3,b=this.maxLength;this.streamDuration=a,a>=b&&(a=b,this.stop()),this.setDuration(b),this.setCurrentTime(a,b)},setCurrentTime:function(a,b){switch(this.getRecordType()){case this.AUDIO_ONLY:this.surfer.setCurrentTime(a,b);break;case this.VIDEO_ONLY:case this.AUDIO_VIDEO:case this.ANIMATION:var c=Math.min(a,b);this.player().controlBar.currentTimeDisplay.el().firstChild.innerHTML=this.formatTime(c,b)}},setDuration:function(a){switch(this.getRecordType()){case this.AUDIO_ONLY:this.surfer.setDuration(a);break;case this.VIDEO_ONLY:case this.AUDIO_VIDEO:case this.ANIMATION:this.player().controlBar.durationDisplay.el().firstChild.innerHTML=this.formatTime(a,a)}},load:function(a){switch(this.getRecordType()){case this.AUDIO_ONLY:this.surfer.load(a);break;case this.IMAGE_ONLY:case this.VIDEO_ONLY:case this.AUDIO_VIDEO:case this.ANIMATION:this.mediaElement.src=a}},destroy:function(){switch(this._recording=!1,this._processing=!1,this.clearInterval(this.countDown),this.getRecordType()){case this.AUDIO_ONLY:this.surfer.destroy();break;case this.IMAGE_ONLY:case this.VIDEO_ONLY:case this.AUDIO_VIDEO:case this.ANIMATION:this.player().dispose()}},getRecordType:function(){return this.recordImage?this.IMAGE_ONLY:this.recordAnimation?this.ANIMATION:this.recordAudio&&!this.recordVideo?this.AUDIO_ONLY:this.recordAudio&&this.recordVideo?this.AUDIO_VIDEO:!this.recordAudio&&this.recordVideo?this.VIDEO_ONLY:void 0},createSnapshot:function(){var a=this.captureFrame();this.player().recordedData=a.toDataURL("image/png"),this.mediaElement.style.display="none",this.player().recordCanvas.show(),this.stop()},captureFrame:function(){var a=this.player().recordCanvas.el().firstChild;return a.width=this.player().width(),a.height=this.player().height(),a.getContext("2d").drawImage(this.mediaElement,0,0,a.width,a.height),a},startVideoPreview:function(){this.off("timeupdate"),this.off("play"),this.mediaElement.muted=!0,this.load(URL.createObjectURL(this.stream)),this.mediaElement.play()},showAnimation:function(){var a=this.player().animationDisplay.el().firstChild;a.width=this.player().width(),a.height=this.player().height(),this.player().recordCanvas.hide(),a.src=this.mediaURL,this.player().animationDisplay.show()},hideAnimation:function(){this.player().recordCanvas.show(),this.player().animationDisplay.hide()},onPlayerStart:function(){this.player().seeking()&&(this.load(this.mediaURL),this.player().play()),this.getRecordType()===this.AUDIO_VIDEO&&this.isChrome()&&!this._recording&&(this.extraAudio.currentTime=this.player().currentTime(),this.extraAudio.play())},onPlayerPause:function(){this.extraAudio.pause()},formatTime:function(a,b){b=b||a;var c=Math.floor(a%60),d=Math.floor(a/60%60),e=Math.floor(a/3600),f=Math.floor(b/60%60),g=Math.floor(b/3600),h=Math.floor(1e3*(a-c));return(isNaN(a)||a===1/0)&&(e=d=c=h="-"),b>0&&b<this.msDisplayMax?(100>h&&(h=10>h?"00"+h:"0"+h),h=":"+h):h="",e=e>0||g>0?e+":":"",d=((e||f>=10)&&10>d?"0"+d:d)+":",c=10>c?"0"+c:c,e+d+c+h}});var c,d,e,f,g,h;c=b.Button.extend({init:function(a,c){b.Button.call(this,a,c),this.on("click",this.onClick),this.on(a,"startRecord",this.onStart),this.on(a,"stopRecord",this.onStop)}}),c.prototype.onClick=function(a){a.stopImmediatePropagation();var b=this.player().recorder;b.isRecording()?b.stop():b.start()},c.prototype.onStart=function(){this.removeClass("vjs-record-stop"),this.addClass("vjs-record-start"),this.el().firstChild.firstChild.innerHTML=this.localize("Stop")},c.prototype.onStop=function(){this.removeClass("vjs-record-start"),this.addClass("vjs-record-stop"),this.el().firstChild.firstChild.innerHTML=this.localize("Record")},d=b.Button.extend({init:function(a,c){b.Button.call(this,a,c),this.on("click",this.onClick),this.on(a,"startRecord",this.onStart),this.on(a,"stopRecord",this.onStop)}}),d.prototype.onClick=function(a){a.stopImmediatePropagation();var b=this.player().recorder;b.isProcessing()?(b._processing=!1,this.player().recordCanvas.hide(),this.player().el().firstChild.style.display="block",this.onStop()):b.start()},d.prototype.onStart=function(){this.removeClass("vjs-record-stop"),this.addClass("vjs-record-start"),this.el().firstChild.firstChild.innerHTML=this.localize("Retry")},d.prototype.onStop=function(){this.removeClass("vjs-record-start"),this.addClass("vjs-record-stop"),this.el().firstChild.firstChild.innerHTML=this.localize("Image")},e=b.Button.extend({init:function(a,c){b.Button.call(this,a,c),this.on("click",this.onClick)}}),e.prototype.onClick=function(a){a.stopImmediatePropagation(),this.player().recorder.getDevice()},f=b.Component.extend({init:function(a,c){b.Component.call(this,a,c),this.on(a,"startRecord",this.show),this.on(a,"stopRecord",this.hide)}}),f.prototype.disable=function(){this.off(this.player(),"startRecord",this.show),this.off(this.player(),"stopRecord",this.hide)},g=b.Component.extend(),h=b.Component.extend();var i=function(a,c){var d={className:"vjs-"+a+"-button vjs-control",innerHTML:'<div class="vjs-control-content"><span class="vjs-control-text">'+c+"</span></div>",role:"button","aria-live":"polite",tabIndex:0};return b.Component.prototype.createEl(null,d)},j=function(){var a={className:"vjs-record",tabIndex:0};return b.Component.prototype.createEl(null,a)},k={image:!1,audio:!1,video:!1,animation:!1,maxLength:10,audioEngine:"recordrtc",audioBufferSize:4096,audioSampleRate:44100,audioWorkerURL:"",audioModuleURL:"",animationFrameRate:200,animationQuality:10,debug:!1},l=function(a){var l=b.util.mergeOptions(k,a),m=this;m.recorder=new b.Recorder(m,{el:j(),options:l}),m.el().appendChild(m.recorder.el()),m.deviceButton=new e(m,{el:i("device",m.localize("Device"))}),m.recorder.el().appendChild(m.deviceButton.el()),m.recordIndicator=new f(m,{el:b.Component.prototype.createEl(null,{className:"vjs-record-indicator vjs-control"})}),m.recordIndicator.hide(),m.recorder.el().appendChild(m.recordIndicator.el()),m.recordCanvas=new g(m,{el:b.Component.prototype.createEl(null,{className:"vjs-record-canvas",innerHTML:"<canvas></canvas>"})}),m.recordCanvas.hide(),m.recorder.el().appendChild(m.recordCanvas.el()),m.animationDisplay=new h(m,{el:b.Component.prototype.createEl(null,{className:"vjs-animation-display",innerHTML:"<img />"})}),m.animationDisplay.hide(),m.recorder.el().appendChild(m.animationDisplay.el()),m.cameraButton=new d(m,{el:i("camera",m.localize("Image"))}),m.cameraButton.hide(),m.controlBar.el().insertBefore(m.cameraButton.el(),m.controlBar.el().firstChild),m.recordToggle=new c(m,{el:i("record",m.localize("Record"))}),m.recordToggle.hide(),m.controlBar.el().insertBefore(m.recordToggle.el(),m.controlBar.el().firstChild)};b.plugin("record",l)}(window,window.videojs);